---
title: "votacao_crime"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(here)
library(viridis)
library(skimr)
library(readxl)

```

## Analise de dados

```{r}

votacoes = read_delim("dados/votacao_candidato_munzona_2016_RJ.csv", delim = ";", locale = locale(encoding = 'latin1'))
ocorrencias = read_delim("dados/BaseDPEvolucaoMensalCisp.csv", delim = ";", locale = locale(encoding = 'latin1'))
codigos = read_delim("dados/policia_dps_areas.csv", delim = ",")
```

```{r}

glimpse(votacoes)
```

### Filtrando para o rio de janeiro
```{r}

votacoes_rio = votacoes %>% 
              filter(CD_MUNICIPIO == 60011, 
                       DS_SIT_TOT_TURNO == "ELEITO" | 
                       DS_SIT_TOT_TURNO == "ELEITO POR MÉDIA" | 
                       DS_SIT_TOT_TURNO == "ELEITO POR QP") %>%
              select('ANO_ELEICAO', 'NR_TURNO', 
              'NM_MUNICIPIO', 'NR_ZONA', 'CD_CARGO', 'SQ_CANDIDATO', 
              'NM_CANDIDATO', 'DS_SITUACAO_CANDIDATURA', 'SG_PARTIDO', 
              'NM_PARTIDO', 'QT_VOTOS_NOMINAIS', 'ST_VOTO_EM_TRANSITO', 
              'DS_SIT_TOT_TURNO')
              
```

### Importanto dados de bairros
```{r}
locais = read_excel("dados/locais.xlsx", skip=2)

glimpse(locais)

```

### Juntando dados de locais e votações
```{r}

locais = locais %>% mutate(NR_ZONA = ZE)

votacoes_bairros = inner_join(votacoes_rio, locais, by="NR_ZONA")

locais %>% group_by(BAIRRO) %>% count() %>% View()

votacoes_bairros = votacoes_bairros %>% 
        select('ANO_ELEICAO', 'NR_ZONA', 'BAIRRO', 'SQ_CANDIDATO', 
              'NM_CANDIDATO', 'NM_PARTIDO', 'QT_VOTOS_NOMINAIS',
              'DS_SIT_TOT_TURNO', 'ENDEREÇO')
```

### Maiores votações
```{r}

# total
votacoes_bairros = votacoes_bairros %>% 
  group_by(NM_CANDIDATO) %>%
  mutate(total_votos = sum(QT_VOTOS_NOMINAIS))
  
#proporcao
votacoes_bairros = votacoes_bairros %>% 
  group_by(NM_CANDIDATO, NR_ZONA) %>%
  mutate(proporcao = QT_VOTOS_NOMINAIS / total_votos)

votacao_resumo = votacoes_bairros %>%
  select(NR_ZONA, NM_CANDIDATO, BAIRRO, proporcao)

votacao_resumo = arrange(votacao_resumo, NM_CANDIDATO, desc(proporcao))

bairro_candidato = votacao_resumo %>% 
  group_by(NM_CANDIDATO) %>% 
  mutate(max_proporcao = max(proporcao)) %>% 
  filter(proporcao == max_proporcao) %>% 
  select(-max_proporcao)

bairro_candidato = bairro_candidato %>% mutate(porcentagem = proporcao * 100)

bairro_candidato

write_csv(bairro_candidato, "dados/bairros_candidatos.csv")

```

### Filtrando risp específicas

```{r}
# AISP 2 - Catete, Cosme Velho, Flamengo, Glória, Laranjeiras, Botafogo, Humaitá e Urca

isp2 = c("CATETE", "COSME VELHO", "FLAMENGO", "GLÓRIA", "LARANJEIRAS", "BOTAFOGO", "HUMAITÁ", "URCA")

bairro_candidato %>% filter( BAIRRO %in% isp2) %>% View()

# votacoes_bairros %>% group_by(BAIRRO) %>% count() %>% View()

write_csv(votacoes_bairros, "dados/votacoes_bairros.csv")

votacao_resumo %>% filter(NM_CANDIDATO == "MARIELLE FRANCISCO DA SILVA") %>% View()

# AISP 22 - Benfica, Bonsucesso, Higienópolis, Manguinhos, Maré e Ramos

isp22 = c("BENFICA", "BONSUCESSO", "HIGIENÓPOLIS", "MANGUINHOS", "MARÉ", "RAMOS")

bairro_candidato %>% filter( BAIRRO %in% isp22) %>% View()

votacoes_bairros %>% group_by(BAIRRO) %>% count() %>% View()

```

### Zonas e bairros

```{r}
zonas_bairros = read_csv("dados/bairros_list.csv")

zonas_bairros = zonas_bairros %>% mutate(NR_ZONA = Zona)

votacoes_rio_novos_bairros = inner_join(votacoes_bairros, zonas_bairros, by="NR_ZONA")

votacoes_rio_novos_bairros = votacoes_rio_novos_bairros %>% 
  select('ANO_ELEICAO', 'NR_ZONA', 'BAIRRO', 'bairros', 'lista', 'SQ_CANDIDATO', 
              'NM_CANDIDATO', 'NM_PARTIDO', 'QT_VOTOS_NOMINAIS',
              'DS_SIT_TOT_TURNO', 'ENDEREÇO')
```

### Nova proporcao
```{r}

# total
votacoes_rio_novos_bairros = votacoes_rio_novos_bairros %>% 
  group_by(NM_CANDIDATO) %>%
  mutate(total_votos = sum(QT_VOTOS_NOMINAIS))

#proporcao
votacoes_rio_novos_bairros = votacoes_rio_novos_bairros %>% 
  group_by(NM_CANDIDATO, NR_ZONA) %>%
  mutate(proporcao = QT_VOTOS_NOMINAIS / total_votos)

votacao_resumo = votacoes_rio_novos_bairros %>%
  select(NR_ZONA, NM_CANDIDATO, BAIRRO, proporcao, lista, bairros, QT_VOTOS_NOMINAIS, total_votos)

votacao_resumo = arrange(votacao_resumo, NM_CANDIDATO, desc(proporcao))

dados_finais = votacao_resumo %>% 
  group_by(NM_CANDIDATO) %>% 
  mutate(max_proporcao = max(proporcao)) %>% 
  filter(proporcao == max_proporcao) %>% 
  select(-max_proporcao)

dados_finais_ = votacao_resumo %>%
  group_by(bairros) %>% 
  top_n(n = 5, wt = proporcao) %>%
  mutate(porcentagem = proporcao * 100)

dados_finais = dados_finais %>% mutate(porcentagem = proporcao * 100)

write_csv(dados_finais, "dados/dados_finais.csv")
```

### Merge final

```{r}

# AISP 2 - Catete, Cosme Velho, Flamengo, Glória, Laranjeiras, Botafogo, Humaitá e Urca
# AISP 22 - Benfica, Bonsucesso, Higienópolis, Manguinhos, Maré e Ramos

risp2 = c("CATETE", "COSMEVELHO", "FLAMENGO", "GLÓRIA", "LARANJEIRAS", "BOTAFOGO", "HUMAITÁ", "URCA")
risp22 = c("BENFICA", "BONSUCESSO", "HIGIENÓPOLIS", "MANGUINHOS", "MARÉ", "RAMOS")

dados_finais_$risp2 = str_detect(dados_finais_$lista, pattern = paste(risp2, collapse = "|"))
dados_finais_$risp22 = str_detect(dados_finais_$lista, pattern = paste(risp22, collapse = "|"))

```

### Visualizando codigos isp e região
```{r}

codigos = codigos %>% select(-geom)

codigos %>% select(Região_Metropolitana) %>% group_by(Região_Metropolitana) %>% count()

codigos %>% select(Município_da_DP) %>% group_by(Município_da_DP) %>% count()

codigos_rio = codigos %>% filter(Município_da_DP == 'Rio de Janeiro')

glimpse(codigos)
```

- Eleitos com algumas caracterização e onde foram votados

- Ocorrencia do isp por regiao

- Media nacional

- Media da cidade do Rio
